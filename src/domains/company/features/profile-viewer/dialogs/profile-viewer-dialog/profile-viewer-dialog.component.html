<h2 mat-dialog-title class="dialog-title">
  <!-- Company Name in the header -->
  <div class="flex items-center">
    <!-- Use optional chaining for logoUrl and fallback to a placeholder -->
    <img [src]="data.basicInfo?.logoUrl || 'https://placehold.co/50x50/cccccc/ffffff?text=Logo'" alt="Company Logo" class="w-12 h-12 rounded-full mr-4 object-contain">
    <!-- Use optional chaining and fallbacks for legalName/tradingName -->
    {{ data.basicInfo?.legalName || data.basicInfo?.tradingName || 'Company Profile' }}
  </div>
  <!-- Close button -->
  <button mat-icon-button (click)="dialogRef.close()" class="dialog-close-button">
    <mat-icon>close</mat-icon>
  </button>
</h2>

<mat-dialog-content class="mat-typography dialog-content-scrollable">
  <div class="p-4">
    <!-- Use optional chaining for tagline -->
    <p class="text-blue-700 text-lg font-semibold mb-4">{{ data.descriptive?.tagline || 'N/A' }}</p>

    <mat-divider class="my-6"></mat-divider>

    <!-- General Overview -->
    <mat-card class="section-card">
      <mat-card-header>
        <mat-card-title class="section-title">
          <mat-icon color="primary">info</mat-icon> Overview
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <!-- Use optional chaining for description -->
        <p class="text-gray-700 text-base leading-relaxed mb-3">{{ data.descriptive?.description || 'No description available.' }}</p>
        <mat-divider class="my-3"></mat-divider>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-gray-700 text-sm">
          <div><span class="font-semibold">Legal Name:</span> {{ data.basicInfo?.legalName || 'N/A' }}</div>
          <div *ngIf="data.basicInfo?.tradingName"><span class="font-semibold">Trading Name:</span> {{ data.basicInfo.tradingName }}</div>
          <div *ngIf="data.basicInfo?.dba"><span class="font-semibold">DBA:</span> {{ data.basicInfo.dba }}</div>
          <!-- Use optional chaining for foundedDate and its pipe -->
          <div *ngIf="data.basicInfo?.foundedDate"><span class="font-semibold">Founded:</span> {{ data.basicInfo.foundedDate | date:'mediumDate' }}</div>
          <div *ngIf="data.basicInfo?.companyType"><span class="font-semibold">Type:</span> {{ data.basicInfo.companyType | titlecase }}</div>
          <!-- Use optional chaining and nullish coalescing for industryCodes.join -->
          <div *ngIf="data.basicInfo?.industryCodes?.length"><span class="font-semibold">Industry Codes:</span> {{ data.basicInfo.industryCodes?.join(', ') }}</div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Mission & Values -->
    <mat-card class="section-card" *ngIf="data.descriptive?.mission || data.descriptive?.vision || data.descriptive?.coreValues?.length">
      <mat-card-header>
        <mat-card-title class="section-title">
          <mat-icon color="primary">campaign</mat-icon> Mission & Values
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div *ngIf="data.descriptive?.mission" class="mb-3">
          <span class="font-semibold text-gray-800">Mission:</span> {{ data.descriptive.mission }}
        </div>
        <div *ngIf="data.descriptive?.vision" class="mb-3">
          <span class="font-semibold text-gray-800">Vision:</span> {{ data.descriptive.vision }}
        </div>
        <div *ngIf="data.descriptive?.coreValues?.length">
          <span class="font-semibold text-gray-800">Core Values:</span>
          <ul class="list-disc list-inside ml-4 mt-1 text-gray-700 text-base">
            <li *ngFor="let value of data.descriptive.coreValues">{{ value }}</li>
          </ul>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Operational Details -->
    <mat-card class="section-card" *ngIf="data.operational?.headquarters || data.operational?.employeeCount || data.operational?.operatingCountries?.length">
      <mat-card-header>
        <mat-card-title class="section-title">
          <mat-icon color="primary">business</mat-icon> Operations
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <!-- Use optional chaining for headquarters.address -->
        <div *ngIf="data.operational?.headquarters" class="mb-3">
          <span class="font-semibold">Headquarters:</span> {{ data.operational.headquarters.address }}
        </div>
        <div *ngIf="data.operational?.employeeCount">
          <span class="font-semibold">Employees:</span> {{ data.operational.employeeCount }} ({{ data.operational.employeeRange }})
        </div>
        <!-- Use optional chaining for operatingCountries.join -->
        <div *ngIf="data.operational?.operatingCountries?.length" class="mt-3">
          <span class="font-semibold">Operating Countries:</span> {{ data.operational.operatingCountries?.join(', ') }}
        </div>
        <!-- Use optional chaining for subsidiaries.join -->
        <div *ngIf="data.operational?.subsidiaries?.length" class="mt-3">
          <span class="font-semibold">Subsidiaries:</span> {{ data.operational.subsidiaries?.join(', ') }}
        </div>
        <div *ngIf="data.operational?.locations?.length">
          <mat-divider class="my-3"></mat-divider>
          <span class="font-semibold">Other Locations:</span>
          <ul class="list-disc list-inside ml-4 mt-1 text-gray-700 text-base">
            <li *ngFor="let loc of data.operational.locations">{{ loc.address }}</li>
          </ul>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Contact Information -->
    <mat-card class="section-card" *ngIf="data.contact?.primaryPhone || data.contact?.email || data.contact?.socialMedia?.length">
      <mat-card-header>
        <mat-card-title class="section-title">
          <mat-icon color="primary">contact_mail</mat-icon> Contact
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div *ngIf="data.contact?.primaryPhone" class="mb-2">
          <span class="font-semibold">Phone:</span> {{ data.contact.primaryPhone }}
          <span *ngIf="data.contact?.tollFreePhone"> (Toll-Free: {{ data.contact.tollFreePhone }})</span>
        </div>
        <div *ngIf="data.contact?.email" class="mb-2">
          <span class="font-semibold">Email:</span> <a [href]="'mailto:' + data.contact.email" class="text-blue-600 hover:underline">{{ data.contact.email }}</a>
        </div>
        <div *ngIf="data.contact?.investorEmail" class="mb-2">
          <span class="font-semibold">Investor Email:</span> <a [href]="'mailto:' + data.contact.investorEmail" class="text-blue-600 hover:underline">{{ data.contact.investorEmail }}</a>
        </div>
        <!-- Use optional chaining for websiteUrl -->
        <div *ngIf="data.digitalPresence?.websiteUrl" class="mb-2">
          <span class="font-semibold">Website:</span> <a [href]="data.digitalPresence.websiteUrl" target="_blank" class="text-blue-600 hover:underline">{{ data.digitalPresence.websiteUrl }}</a>
        </div>
        <div *ngIf="data.contact?.socialMedia?.length" class="mt-3">
          <span class="font-semibold">Social Media:</span>
          <div class="flex flex-wrap gap-3 mt-2">
            <!-- Use optional chaining for social.followers -->
            <a *ngFor="let social of data.contact.socialMedia" [href]="social.url" target="_blank" class="flex items-center text-blue-600 hover:underline">
              <mat-icon class="mr-1 text-base">{{ getSocialIcon(social.platform) }}</mat-icon>
              {{ social.platform | titlecase }} ({{ social.followers | number }} followers)
            </a>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Financials -->
    <mat-card class="section-card" *ngIf="data.financials?.financialData?.length || data.financials?.fundingRounds?.length">
      <mat-card-header>
        <mat-card-title class="section-title">
          <mat-icon color="primary">monetization_on</mat-icon> Financials
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div *ngIf="data.financials?.stockSymbol" class="mb-3">
          <span class="font-semibold">Stock Symbol:</span> {{ data.financials.stockSymbol }}
        </div>
        <div *ngIf="data.financials?.financialData?.length" class="mb-3">
          <h5 class="font-semibold mb-2">Financial Data:</h5>
          <table class="w-full text-left border-collapse">
            <thead>
              <tr class="bg-gray-100">
                <th class="py-2 px-4 border-b">Year</th>
                <th class="py-2 px-4 border-b">Revenue</th>
                <th class="py-2 px-4 border-b">Profit</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let financial of data.financials.financialData" class="hover:bg-gray-50">
                <td class="py-2 px-4 border-b">{{ financial.year }}</td>
                <td class="py-2 px-4 border-b">{{ financial.revenue | currency:financial.currency:'symbol':'1.0-0' }}</td>
                <td class="py-2 px-4 border-b">{{ financial.profit | currency:financial.currency:'symbol':'1.0-0' }}</td>
              </tr>
            </tbody>
          </table>
        </div>
        <div *ngIf="data.financials?.fundingRounds?.length">
          <h5 class="font-semibold mt-4 mb-2">Funding Rounds:</h5>
          <ul class="list-none space-y-2">
            <li *ngFor="let round of data.financials.fundingRounds" class="p-3 bg-blue-50 rounded-md">
              <span class="font-semibold">{{ round.roundType }} ({{ round.date | date:'mediumDate' }})</span>:
              {{ round.amount | currency:'USD':'symbol':'1.0-0' }}
              <span *ngIf="round.valuation"> (Valuation: {{ round.valuation | currency:'USD':'symbol':'1.0-0' }})</span>
              <!-- Use optional chaining for investors.join -->
              <div *ngIf="round.investors?.length" class="text-sm text-gray-600 mt-1">
                Investors: {{ round.investors.join(', ') }}
              </div>
            </li>
          </ul>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Key People -->
    <mat-card class="section-card" *ngIf="data.relationships?.keyPeople?.length">
      <mat-card-header>
        <mat-card-title class="section-title">
          <mat-icon color="primary">person</mat-icon> Key People
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div *ngFor="let person of data.relationships.keyPeople" class="p-3 bg-gray-50 rounded-md flex items-center shadow-sm">
            <mat-icon class="mr-2 text-xl" color="accent">account_circle</mat-icon>
            <div>
              <div class="font-semibold text-gray-800">{{ person.name }}</div>
              <div class="text-sm text-gray-600">{{ person.title }}</div>
              <!-- Use optional chaining for linkedinUrl -->
              <a *ngIf="person.linkedinUrl" [href]="person.linkedinUrl" target="_blank" class="text-blue-600 text-xs hover:underline">LinkedIn</a>
            </div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Products & Services -->
    <mat-card class="section-card" *ngIf="data.relationships?.productsServices?.length">
      <mat-card-header>
        <mat-card-title class="section-title">
          <mat-icon color="primary">apps</mat-icon> Products & Services
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="space-y-4">
          <div *ngFor="let product of data.relationships.productsServices" class="p-4 border border-blue-100 rounded-lg bg-blue-50">
            <h4 class="font-semibold text-gray-800 text-lg mb-1">{{ product.name }}</h4>
            <div class="text-sm text-blue-800 mb-2">{{ product.category }}</div>
            <p class="text-gray-700 text-base mb-2">{{ product.description }}</p>
            <!-- Use optional chaining for product.tags.join -->
            <div *ngIf="product.tags?.length" class="text-xs text-gray-600">Tags: {{ product.tags?.join(', ') }}</div>
            <!-- Use optional chaining for launchDate -->
            <div *ngIf="product.launchDate" class="text-xs text-gray-600">Launched: {{ product.launchDate | date:'mediumDate' }}</div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Relationships (Clients, Partners, Competitors) -->
    <mat-card class="section-card" *ngIf="data.relationships?.clients?.length || data.relationships?.partners?.length || data.relationships?.competitors?.length">
      <mat-card-header>
        <mat-card-title class="section-title">
          <mat-icon color="primary">handshake</mat-icon> Relationships
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div *ngIf="data.relationships?.clients?.length" class="mb-3">
          <span class="font-semibold">Clients:</span> {{ data.relationships.clients?.join(', ') }}
        </div>
        <div *ngIf="data.relationships?.partners?.length" class="mb-3">
          <span class="font-semibold">Partners:</span> {{ data.relationships.partners?.join(', ') }}
        </div>
        <div *ngIf="data.relationships?.competitors?.length">
          <span class="font-semibold">Competitors:</span> {{ data.relationships.competitors?.join(', ') }}
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Governance -->
    <mat-card class="section-card" *ngIf="data.governance?.ceo || data.governance?.boardMembers?.length || data.governance?.certifications?.length">
      <mat-card-header>
        <mat-card-title class="section-title">
          <mat-icon color="primary">policy</mat-icon> Governance
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <!-- Use optional chaining for ceo.name and ceo.title -->
        <div *ngIf="data.governance?.ceo">
          <span class="font-semibold">CEO:</span> {{ data.governance.ceo?.name }} ({{ data.governance.ceo?.title }})
        </div>
        <div *ngIf="data.governance?.boardMembers?.length" class="mb-3">
          <span class="font-semibold">Board Members:</span>
          <ul class="list-disc list-inside ml-4 mt-1 text-gray-700 text-base">
            <li *ngFor="let member of data.governance.boardMembers">{{ member.name }} ({{ member.title }})</li>
          </ul>
        </div>
        <!-- Use optional chaining for certifications.join -->
        <div *ngIf="data.governance?.certifications?.length">
          <span class="font-semibold">Certifications:</span> {{ data.governance.certifications?.join(', ') }}
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Digital Presence -->
    <mat-card class="section-card" *ngIf="data.digitalPresence?.websiteUrl || data.digitalPresence?.careersUrl || data.digitalPresence?.techStack?.length || (data.digitalPresence?.monthlyVisitors !== undefined && data.digitalPresence?.monthlyVisitors !== null)">
      <mat-card-header>
        <mat-card-title class="section-title">
          <mat-icon color="primary">desktop_windows</mat-icon> Digital Presence
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div *ngIf="data.digitalPresence?.websiteUrl" class="mb-2">
          <span class="font-semibold">Official Website:</span> <a [href]="data.digitalPresence.websiteUrl" target="_blank" class="text-blue-600 hover:underline">{{ data.digitalPresence.websiteUrl }}</a>
        </div>
        <div *ngIf="data.digitalPresence?.careersUrl" class="mb-2">
          <span class="font-semibold">Careers Page:</span> <a [href]="data.digitalPresence.careersUrl" target="_blank" class="text-blue-600 hover:underline">{{ data.digitalPresence.careersUrl }}</a>
        </div>
        <!-- Use optional chaining for techStack.join -->
        <div *ngIf="data.digitalPresence?.techStack?.length" class="mb-2">
          <span class="font-semibold">Tech Stack:</span> {{ data.digitalPresence.techStack?.join(', ') }}
        </div>
        <!-- This was already fixed, ensuring monthlyVisitors is not undefined/null -->
        <div *ngIf="data.digitalPresence?.monthlyVisitors !== undefined && data.digitalPresence?.monthlyVisitors !== null">
          <span class="font-semibold">Monthly Visitors:</span> {{ data.digitalPresence.monthlyVisitors | number }}
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Scraped Data & Metadata -->
    <mat-card class="section-card" *ngIf="data.scrapedData || data.metadata">
      <mat-card-header>
        <mat-card-title class="section-title">
          <mat-icon color="primary">history_toggle_off</mat-icon> Data Source & Metadata
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div *ngIf="data.scrapedData" class="mb-3">
          <h5 class="font-semibold mb-1">Scraped Data Info:</h5>
          <ul class="list-disc list-inside ml-4 text-gray-700 text-sm">
            <li *ngIf="data.scrapedData.lastScraped">Last Scraped: {{ data.scrapedData.lastScraped | date:'medium' }}</li>
            <li *ngIf="data.scrapedData.confidenceScore">Confidence Score: {{ data.scrapedData.confidenceScore | percent }}</li>
            <li *ngIf="data.scrapedData.sources?.length">Sources:
              <ul class="list-circle list-inside ml-4 text-gray-600 text-xs">
                <li *ngFor="let source of data.scrapedData.sources"><a [href]="source" target="_blank">{{ source }}</a></li>
              </ul>
            </li>
          </ul>
        </div>
        <div *ngIf="data.metadata">
          <h5 class="font-semibold mb-1">Metadata:</h5>
          <ul class="list-disc list-inside ml-4 text-gray-700 text-sm">
            <!-- Use optional chaining for metadata.created and metadata.lastUpdated -->
            <li *ngIf="data.metadata.created">Profile Created: {{ data.metadata.created | date:'medium' }}</li>
            <li *ngIf="data.metadata.lastUpdated">Last Updated: {{ data.metadata.lastUpdated | date:'medium' }}</li>
            <!-- Use optional chaining for dataSources.join -->
            <li *ngIf="data.metadata.dataSources?.length">Data Sources: {{ data.metadata.dataSources?.join(', ') }}</li>
          </ul>
        </div>
      </mat-card-content>
    </mat-card>
  </div>
</mat-dialog-content>

<mat-dialog-actions align="end" class="dialog-actions-footer">
  <button mat-flat-button color="primary" (click)="scrollToTop()" *ngIf="isContentScrollable()">
    <mat-icon>arrow_upward</mat-icon> Top
  </button>
  <button mat-flat-button color="warn" (click)="dialogRef.close()">
    <mat-icon>close</mat-icon> Close
  </button>
  <!-- Use optional chaining for _id when constructing routerLink -->
  <a mat-flat-button color="accent" [routerLink]="['/company/edit', data?._id]" (click)="dialogRef.close()" *ngIf="data?._id">
    <mat-icon>edit</mat-icon> Edit Profile
  </a>
</mat-dialog-actions>
